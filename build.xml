<project name="lombok" default="dist">
	<property name="build.compiler" value="javac1.6" />
	<path id="lombok.deps.path">
		<fileset dir="deps/lombok">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<path id="lombok.libs.path">
		<fileset dir="lib/lombok">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="eclipse.agent.deps.path">
		<fileset dir="deps/agent">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="deps/eclipse.agent">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<path id="eclipse.agent.libs.path">
		<fileset dir="lib/agent">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="lib/eclipse.agent">
			<include name="**/*.jar" />
		</fileset>
	</path>
	
	<path id="netbeans.agent.deps.path">
		<fileset dir="deps/agent">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="deps/netbeans.agent">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<path id="netbeans.agent.libs.path">
		<fileset dir="lib/agent">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="lib/netbeans.agent">
			<include name="**/*.jar" />
		</fileset>
	</path>
	
	<target name="clean">
		<delete dir="build" quiet="true" />
		<delete dir="dist" quiet="true" />
	</target>
	
	<target name="compile">
		<mkdir dir="build/lombok" />
		<javac srcdir="src" debug="on" destdir="build/lombok">
			<classpath refid="lombok.deps.path" />
			<classpath refid="lombok.libs.path" />
		</javac>
		<mkdir dir="build/lombok/META-INF" />
		<mkdir dir="build/lombok/META-INF/services" />
		<echo file="build/lombok/META-INF/services/javax.annotation.processing.Processor">lombok.javac.apt.Processor</echo>
		
		<mkdir dir="build/eclipse.agent" />
		<javac srcdir="src_eclipseagent" debug="on" destdir="build/eclipse.agent">
			<classpath refid="eclipse.agent.deps.path" />
			<classpath refid="eclipse.agent.libs.path" />
		</javac>
		
		<mkdir dir="build/netbeans.agent" />
		<javac srcdir="src_netbeansagent" debug="on" destdir="build/netbeans.agent">
			<classpath refid="netbeans.agent.deps.path" />
			<classpath refid="netbeans.agent.libs.path" />
		</javac>
	</target>
	
	<target name="unpackLibs">
		<unjar dest="build/lombok">
			<path refid="lombok.libs.path" />
		</unjar>
		<unjar dest="build/eclipse.agent">
			<path refid="eclipse.agent.libs.path" />
		</unjar>
		<unjar dest="build/netbeans.agent">
			<path refid="eclipse.agent.libs.path" />
		</unjar>
	</target>
	
	<target name="getVersion" depends="compile">
		<java
			classname="lombok.core.Version"
			classpath="build/lombok"
			failonerror="true"
			output="build/version.txt" />
		<loadresource property="lombok.version">
			<file file="build/version.txt" />
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadresource>
		<delete file="build/version.txt" quiet="true" />
		<echo level="info">Lombok version: ${lombok.version}</echo>
	</target>
	
	<target name="dist" depends="clean, compile, getVersion, unpackLibs">
		<mkdir dir="dist" />
		<jar basedir="build/lombok" destfile="dist/lombok-${lombok.version}.jar">
			<manifest>
				<attribute name="Main-Class" value="lombok.core.ShowUserHelp" />
			</manifest>
		</jar>
		<jar basedir="build/eclipse.agent" destfile="dist/lombok.eclipse.agent-${lombok.version}.jar">
			<manifest>
				<attribute name="Premain-Class" value="lombok.eclipse.agent.EclipsePatcher" />
				<attribute name="Can-Redefine-Classes" value="true" />
			</manifest>
		</jar>
		<jar basedir="build/netbeans.agent" destfile="dist/lombok.netbeans.agent-${lombok.version}.jar">
			<manifest>
				<attribute name="Premain-Class" value="lombok.netbeans.agent.NetbeansPatcher" />
				<attribute name="Can-Redefine-Classes" value="true" />
			</manifest>
		</jar>
		<copy file="dist/lombok-${lombok.version}.jar" tofile="dist/lombok.jar" />
		<copy file="dist/lombok.eclipse.agent-${lombok.version}.jar" tofile="dist/lombok.eclipse.agent.jar" />
		<copy file="dist/lombok.netbeans.agent-${lombok.version}.jar" tofile="dist/lombok.netbeans.agent.jar" />
	</target>
</project>
